<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started with cheem • cheem</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with cheem">
<meta property="og:description" content="cheem">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cheem</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started-with-cheem.html">Getting started with cheem</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nspyrison/cheem/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting started with cheem</h1>
                        <h4 data-toc-skip class="author">Nicholas Spyrison</h4>
            
            <h4 data-toc-skip class="date">2022-02-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nspyrison/cheem/blob/HEAD/vignettes/getting-started-with-cheem.Rmd" class="external-link"><code>vignettes/getting-started-with-cheem.Rmd</code></a></small>
      <div class="hidden name"><code>getting-started-with-cheem.Rmd</code></div>

    </div>

    
    
<!-- #Example vignette: 
https://github.com/njtierney/naniar/blob/master/vignettes/getting-started-w-naniar.Rmd -->
<p><strong>TL;DR</strong>, you can jump straight into the visuals and application with <code><a href="../reference/run_app.html">cheem::run_app()</a></code>, but we suggest you read the introduction to get situated with the context first.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Non-linear models regularly result in more accurate prediction than their linear counterparts. However the number and complexity of the terms in the model make them more opaque to the interpretability of the terms and correspondingly our ability to understand how features (variables or predictors) influence predictions. The emergence of eXplainable Artificial Intelligence (XAI) attempts to bring interpretability back to models.</p>
<p>One part of this is with the use of <em>local explanations</em>. Local explanations approximate the feature importance in the vicinity of one instance (observation).</p>
<div class="figure" style="text-align: center">
<img src="../inst/shiny_apps/cheem_initial/www/lime_nonlinear.png" alt="Illustration of non-linear classification boundary. The use of local explanations approximates the feature importance in the vicinity of one instance. This allow us to understand a change in which features would result in a red plus being classified as a blue circle. From _Ribiro, M. et. all. (2017). Why should I trust you?_" width="224"><p class="caption">
Illustration of non-linear classification boundary. The use of local explanations approximates the feature importance in the vicinity of one instance. This allow us to understand a change in which features would result in a red plus being classified as a blue circle. From <em>Ribiro, M. et. all. (2017). Why should I trust you?</em>
</p>
</div>
<p>Should we trust the purposed feature importance in the vicinity of a misclassified or an extreme residual? An analyst may want to explore the support feature contributions where the explanations makes sense or may be completely unreliable. This is the type of analysis visually explored in <strong>cheem</strong>.</p>
<p>We use the normalized linear-feature attribution as a basis and explore the support of features that confirm this explanation what under which contributions this explanation does not hold. A data visualization <em>tour</em> animates linear projection-embeddings over small changes in the basis. The package <strong>spinifex</strong> facilitates radial, manual tours which vary the contribution of a select feature. By using a radial tour we test the support of the features.</p>
<p>While this framework would for any non-linear model and compatible local explanation we’ll illustrate with <strong>randomForest</strong> models and the tree SHAP local explanation with <strong>treeshap</strong> (available on GitHub).</p>
</div>
<div class="section level2">
<h2 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h2>
<p>The first thing we’ll need are data and tree based model. We’ll use a wrapper function for a <strong>randomForest</strong> modest with modest hyperparameters. This will avoid overfitting and help mitigate the runtime of tree SHAP. Alternatively, <strong>treeshape</strong> and <strong>cheem</strong> are compatible with tree based models from <strong>ranger</strong>, <strong>gbm</strong>, <strong>xgboost</strong>, <strong>catboost</strong>, and <strong>lightgbm</strong>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nspyrison/cheem/" class="external-link">cheem</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nspyrison/spinifex/" class="external-link">spinifex</a></span><span class="op">)</span>

<span class="co">## Classification case, Penguins data</span>
<span class="va">X</span>           <span class="op">&lt;-</span> <span class="va">penguins_na.rm</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>
<span class="va">clas</span>        <span class="op">&lt;-</span> <span class="va">penguins_na.rm</span><span class="op">$</span><span class="va">species</span>
<span class="va">Y</span>           <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">clas</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_l"</span>, <span class="st">"b_d"</span>, <span class="st">"f_l"</span>, <span class="st">"b_m"</span><span class="op">)</span>

<span class="co">## Create a random forest classifying penguin species</span>
<span class="va">rf_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/default_rf.html">default_rf</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## For other compatible tree based models see examples in:</span>
<span class="kw">if</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">?</span><span class="va">is_randomForest</span></code></pre></div>
<p>Next we need to extract the local explanation from each observation. Originally only tree SHAP is supported. Then we’ll prepare the information to be consumed by the cheem visuals.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Local attribution of all observations</span>
<span class="va">shap_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/attr_df_treeshap.html">attr_df_treeshap</a></span><span class="op">(</span><span class="va">rf_fit</span>, <span class="va">X</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, noisy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## Extract statistics and prep for cheem consumption</span>
<span class="va">this_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cheem_ls.html">cheem_ls</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, class <span class="op">=</span> <span class="va">clas</span>,
                    model <span class="op">=</span> <span class="va">rf_fit</span>, attr_df <span class="op">=</span> <span class="va">shap_df</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Now we are done with all of the leg work, let’s turn our attention towards the visuals and analysis.</p>
</div>
<div class="section level2">
<h2 id="cheem-viewer">Cheem viewer<a class="anchor" aria-label="anchor" href="#cheem-viewer"></a>
</h2>
<p>We have extracted tree SHAP, an feature importance measure in the vicinity of each observation. We need to identify an instance of interest to explore; we do so with the linked brushing available in the <em>global view</em>. Then we will vary contributions from different features to test the support an explanation in a <em>radial tour</em></p>
<div class="section level3">
<h3 id="global-view">Global view<a class="anchor" aria-label="anchor" href="#global-view"></a>
</h3>
<p>To get more complete view lets look at approximations of the data space, attribution space, and model fits side-by-side with linked brushing with the help of <strong>plotly</strong> and <strong>crosstalk</strong>. The model information is essentially the confusion matrix for the classification case.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/global_view.html">global_view</a></span><span class="op">(</span><span class="va">this_ls</span>, primary_obs <span class="op">=</span> <span class="fl">243</span>, comparison_obs <span class="op">=</span> <span class="fl">169</span>,
            height_px <span class="op">=</span> <span class="fl">240</span>, width_px <span class="op">=</span> <span class="fl">720</span>, as_ggplot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="getting-started-with-cheem_files/figure-html/unnamed-chunk-3-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>From this <em>global view</em> we want to identify a primary instance (PI) and optionally a comparison instance (CI) to explore. Misclassified or observations with high residuals are good targets for further exploration. One point sticks out in this case. Instance 243 (shown as *) is a Gentoo (purple) penguin, while the model predict it to be a Chinstrap penguin. Peguin 169 (shown as x) is reasonably close by and correctly predicted as Gentoo. In practice we used linked brushing and misclassification information to guide our search.</p>
</div>
<div class="section level3">
<h3 id="radial-tour">Radial tour<a class="anchor" aria-label="anchor" href="#radial-tour"></a>
</h3>
<p>There is a lot to unpack here. The normalized distribution of all feature attribution from all instances are shown as parallel coordinates lines. The above selected PI and CI are shown here as a dashed and dotted line respectively. The first thing we notice is that the attribution of the PI is close to it’s (incorrect) prediction of Chinstrap (orange) in terms of bill length (<code>b_l</code>) and flipper length (<code>f_l</code>). In terms of bill depth and body mass (<code>b_d</code> and <code>b_m</code>) it is more like its observed species Gentoo (purple). We select flipper length as the feature to manipulate.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Normalized attribution basis of the PI</span>
<span class="va">bas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basis_attr_df.html">basis_attr_df</a></span><span class="op">(</span><span class="va">shap_df</span>, rownum <span class="op">=</span> <span class="fl">243</span><span class="op">)</span>
<span class="co">## Default to feature to manipulation; </span>
<span class="co">#### the feature with largest separation between PI and CI attribution</span>
<span class="va">mv</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/manip_var_of_attr_df.html">manip_var_of_attr_df</a></span><span class="op">(</span><span class="va">shap_df</span>, primary_obs <span class="op">=</span> <span class="fl">243</span>, comparison_obs <span class="op">=</span> <span class="fl">169</span><span class="op">)</span>
<span class="co">## Make the radial tour</span>
<span class="va">ggt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/radial_cheem_tour.html">radial_cheem_tour</a></span><span class="op">(</span>
  <span class="va">this_ls</span>, basis <span class="op">=</span> <span class="va">bas</span>, manip_var <span class="op">=</span> <span class="va">mv</span>,
  primary_obs <span class="op">=</span> <span class="fl">243</span>, comparison_obs <span class="op">=</span> <span class="fl">169</span>, angle <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span>

<span class="co">## Animate it</span>
<span class="fu"><a href="https://rdrr.io/pkg/spinifex/man/animate_gganimate.html" class="external-link">animate_gganimate</a></span><span class="op">(</span><span class="va">ggt</span>, fps <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> 
  <span class="co">#height = 2, width = 4.5, units = "in", res = 150</span>
<span class="co">## Or as a plotly html widget</span>
<span class="co">#animate_plotly(ggt, fps = 4)</span></code></pre></div>
<p><img src="tour_penguins.gif" width="100%" style="display: block; margin: auto;"></p>
<p>Starting from the attribution projection, this instance already looks more like its observed Gentoo than predicted Chinstrap. However, by frame 8, the basis has a full contribution of flipper length and does look more like the predicted Chinstrap. Looking at the parallel coordinate lines on the basis visual we can see that flipper length has a large gap between PI and CI, lets check the original variables to digest.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">penguins_na.rm</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length_mm</span>,
                           y <span class="op">=</span> <span class="va">flipper_length_mm</span>,
                           colour <span class="op">=</span> <span class="va">species</span>,
                           shape <span class="op">=</span> <span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## Highlight PI, *</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">penguins_na.rm</span><span class="op">[</span><span class="fl">243</span>, <span class="op">]</span>, shape <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## Theme, scaling, color, and labels</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Flipper length [mm]"</span>, x <span class="op">=</span> <span class="st">"Bill length [mm]"</span>, 
       color <span class="op">=</span> <span class="st">"Observed species"</span>, shape <span class="op">=</span> <span class="st">"Observed species"</span><span class="op">)</span></code></pre></div>
<p><img src="getting-started-with-cheem_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"></p>
<p>This profile, with two features that are most distinguished between the PI and CI. This instance is nested in the in between the Chinstrap penguins. That makes this instance particularly hard for a random forest model to classify as decision tree can only make partition on one value (horizontal and vertical lines here).</p>
</div>
<div class="section level3">
<h3 id="shiny-application">Shiny application<a class="anchor" aria-label="anchor" href="#shiny-application"></a>
</h3>
<p>We provide an interactive <strong>shiny</strong> application. Interactive features are made possible with <strong>plotly</strong>, <strong>crosstalk</strong>, and <strong>DT</strong>. We have preprocessed simulated and modern datasets for you to explore this analysis with. Alternatively, bring your own data by saving the return of <code><a href="../reference/cheem_ls.html">cheem_ls()</a></code> as an .rds file. Follow along with the example in <code><a href="../reference/cheem_ls.html">?cheem_ls</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>Interpretability of black-box models is important to maintain. Local explanation extend this interpretability by approximating the feature importance in the vicinity of one instance. We purpose post-hoc analysis of these local explanations. First we explore them in a global, full instance context. Then we explore the support of the local explanation to see where it seems plausible or unreliable.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nicholas Spyrison.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
